{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard Guru BK{% endblock %}

{% block content %}
<div class="bk-dashboard-page">
<div class="bk-dashboard">

<!-- HEADER -->
<header class="dashboard-header">
<div>
<span class="bk-badge">Akses Khusus Guru BK</span>
<h1>Dashboard Guru BK</h1>
<p>Monitoring dan analisis tren kasus bullying</p>
</div>
<a href="{% url 'bk_download_laporan' %}" class="btn-download">Download Laporan</a>
</header>


<!-- SUMMARY -->
<section class="dashboard-cards">
<div class="summary-card">
<p>Total Laporan</p>
<h2>{{ total_laporan }}</h2>
</div>

<div class="summary-card">
<p>Laporan Baru</p>
<h2>{{ laporan_baru }}</h2>
</div>

<div class="summary-card">
<p>Diproses</p>
<h2>{{ sedang_diproses }}</h2>
</div>

<div class="summary-card">
<p>Selesai</p>
<h2>{{ selesai }}</h2>
</div>
</section>


<!-- FILTER -->
<form method="get" class="filter-bar filter-horizontal">

<select name="jenis">
<option value="">Semua Jenis</option>
{% for val,label in jenis_choices %}
<option value="{{ val }}" {% if val == selected_jenis %}selected{% endif %}>
{{ label }}
</option>
{% endfor %}
</select>

<select name="kelas">
<option value="">Semua Kelas</option>
{% for val,label in kelas_choices %}
<option value="{{ val }}" {% if val == selected_kelas %}selected{% endif %}>
{{ label }}
</option>
{% endfor %}
</select>

<select name="status">
<option value="">Semua Status</option>
<option value="baru" {% if selected_status == "baru" %}selected{% endif %}>Baru</option>
<option value="diproses" {% if selected_status == "diproses" %}selected{% endif %}>Diproses</option>
<option value="selesai" {% if selected_status == "selesai" %}selected{% endif %}>Selesai</option>
</select>

<select name="periode" id="periodeSelect">
<option value="semua" {% if periode == "semua" %}selected{% endif %}>Semua Waktu</option>
<option value="hari" {% if periode == "hari" %}selected{% endif %}>Per Hari</option>
<option value="bulan" {% if periode == "bulan" %}selected{% endif %}>Per Bulan</option>
<option value="tahun" {% if periode == "tahun" %}selected{% endif %}>Per Tahun</option>
</select>

<input type="date" name="tanggal" id="filterTanggal" value="{{ request.GET.tanggal }}">

<select name="bulan" id="filterBulan">
<option value="">Pilih Bulan</option>
<option value="1">Januari</option>
<option value="2">Februari</option>
<option value="3">Maret</option>
<option value="4">April</option>
<option value="5">Mei</option>
<option value="6">Juni</option>
<option value="7">Juli</option>
<option value="8">Agustus</option>
<option value="9">September</option>
<option value="10">Oktober</option>
<option value="11">November</option>
<option value="12">Desember</option>
</select>

<select name="tahun" id="filterTahun">
<option value="">Pilih Tahun</option>
{% for t in daftar_tahun %}
<option value="{{ t.year }}" {% if request.GET.tahun == t.year|stringformat:"s" %}selected{% endif %}>
{{ t.year }}
</option>
{% endfor %}
</select>

<button type="submit" class="btn-filter">Filter</button>

</form>


<!-- CHART SECTION -->
<div class="chart-section">

<!-- STATUS -->
<div class="chart-card">
<h4>Grafik Status Laporan</h4>
<canvas id="statusChart"></canvas>

<div class="chart-info">
{% for i in grafik_status %}
<span class="info-badge">{{ i.status|title }} = {{ i.total }}</span>
{% endfor %}
<span class="info-total">Total = {{ total_laporan }}</span>
</div>
</div>


<!-- JENIS -->
<div class="chart-card">
<h4>Grafik Jenis Bullying</h4>
<canvas id="jenisChart"></canvas>

<div class="chart-info">
{% for i in grafik_jenis %}
<span class="info-badge">{{ i.jenis_bullying|title }} = {{ i.total }}</span>
{% endfor %}
<span class="info-total">Total = {{ total_laporan }}</span>
</div>
</div>


<!-- KELAS -->
<div class="chart-card">
<h4>Grafik Kelas Korban</h4>
<canvas id="kelasChart"></canvas>

<div class="chart-info">
{% for i in grafik_kelas %}
<span class="info-badge">{{ i.kelas_korban }} = {{ i.total }}</span>
{% endfor %}
<span class="info-total">Total = {{ total_laporan }}</span>
</div>
</div>


<!-- TREN -->
<div class="chart-card">
<h4>Grafik Tren Laporan</h4>
<canvas id="trenChart"></canvas>

<div class="chart-info">
{% if tren_detail %}
{% for i in tren_detail %}
<span class="info-badge">{{ i.label }} = {{ i.total }}</span>
{% endfor %}
{% endif %}
<span class="info-total">Total = {{ total_laporan }}</span>
</div>
</div>

</div>
</div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

function chart(id,type,labels,data){

let config={
type:type,
data:{labels:labels,datasets:[{data:data}]},
options:{responsive:true,maintainAspectRatio:false}
};

if(type!=="pie"){
config.options.scales={y:{beginAtZero:true,ticks:{stepSize:1}}};
}

new Chart(document.getElementById(id),config);
}

chart("statusChart","pie",
[{% for i in grafik_status %}"{{ i.status }}",{% endfor %}],
[{% for i in grafik_status %}{{ i.total }},{% endfor %}]
);

chart("jenisChart","bar",
[{% for i in grafik_jenis %}"{{ i.jenis_bullying }}",{% endfor %}],
[{% for i in grafik_jenis %}{{ i.total }},{% endfor %}]
);

chart("kelasChart","bar",
[{% for i in grafik_kelas %}"{{ i.kelas_korban }}",{% endfor %}],
[{% for i in grafik_kelas %}{{ i.total }},{% endfor %}]
);

chart("trenChart","bar",
[{% for i in grafik_tren %}"{{ i.waktu|date:'d M Y' }}",{% endfor %}],
[{% for i in grafik_tren %}{{ i.total }},{% endfor %}]
);

</script>


<script>
const periode=document.getElementById("periodeSelect");
const tanggal=document.getElementById("filterTanggal");
const bulan=document.getElementById("filterBulan");
const tahun=document.getElementById("filterTahun");

function updateFilter(){

tanggal.style.display='none';
bulan.style.display='none';
tahun.style.display='none';

if(periode.value==='hari') tanggal.style.display='inline-block';

if(periode.value==='bulan'){
bulan.style.display='inline-block';
tahun.style.display='inline-block';
}

if(periode.value==='tahun') tahun.style.display='inline-block';

}

periode.addEventListener('change',updateFilter);
updateFilter();
</script>

{% endblock %}
