{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard Guru BK{% endblock %}

{% block content %}
<div class="bk-dashboard-page">
<div class="bk-dashboard">

<header class="dashboard-header">
  <div>
    <span class="bk-badge">Akses Khusus Guru BK</span>
    <h1>Dashboard Guru BK</h1>
    <p>Monitoring dan analisis tren kasus bullying</p>
  </div>
  <a href="{% url 'bk_download_laporan' %}" class="btn-download">Download Laporan</a>
</header>

<section class="dashboard-cards">
  <div class="summary-card">
    <p>Total Laporan</p>
    <h2>{{ total_laporan }}</h2>
  </div>
  <div class="summary-card">
    <p>Laporan Baru</p>
    <h2>{{ laporan_baru }}</h2>
  </div>
  <div class="summary-card">
    <p>Diproses</p>
    <h2>{{ sedang_diproses }}</h2>
  </div>
  <div class="summary-card">
    <p>Selesai</p>
    <h2>{{ selesai }}</h2>
  </div>
</section>

<form method="get" class="filter-bar">

<select name="jenis">
<option value="">Semua Jenis</option>
{% for val,label in jenis_choices %}
<option value="{{ val }}" {% if val == selected_jenis %}selected{% endif %}>{{ label }}</option>
{% endfor %}
</select>

<select name="kelas">
<option value="">Semua Kelas</option>
{% for val,label in kelas_choices %}
<option value="{{ val }}" {% if val == selected_kelas %}selected{% endif %}>{{ label }}</option>
{% endfor %}
</select>

<select name="status">
<option value="">Semua Status</option>
<option value="baru" {% if selected_status == "baru" %}selected{% endif %}>Baru</option>
<option value="diproses" {% if selected_status == "diproses" %}selected{% endif %}>Diproses</option>
<option value="selesai" {% if selected_status == "selesai" %}selected{% endif %}>Selesai</option>
</select>

<select name="periode" id="periodeSelect">
<option value="semua" {% if periode == "semua" %}selected{% endif %}>Semua Waktu</option>
<option value="hari" {% if periode == "hari" %}selected{% endif %}>Per Hari</option>
<option value="bulan" {% if periode == "bulan" %}selected{% endif %}>Per Bulan</option>
<option value="tahun" {% if periode == "tahun" %}selected{% endif %}>Per Tahun</option>
</select>

<input type="date" name="tanggal" id="filterTanggal" value="{{ request.GET.tanggal }}">

<select name="bulan" id="filterBulan">
<option value="">Pilih Bulan</option>
<option value="1" {% if request.GET.bulan == "1" %}selected{% endif %}>Januari</option>
<option value="2" {% if request.GET.bulan == "2" %}selected{% endif %}>Februari</option>
<option value="3" {% if request.GET.bulan == "3" %}selected{% endif %}>Maret</option>
<option value="4" {% if request.GET.bulan == "4" %}selected{% endif %}>April</option>
<option value="5" {% if request.GET.bulan == "5" %}selected{% endif %}>Mei</option>
<option value="6" {% if request.GET.bulan == "6" %}selected{% endif %}>Juni</option>
<option value="7" {% if request.GET.bulan == "7" %}selected{% endif %}>Juli</option>
<option value="8" {% if request.GET.bulan == "8" %}selected{% endif %}>Agustus</option>
<option value="9" {% if request.GET.bulan == "9" %}selected{% endif %}>September</option>
<option value="10" {% if request.GET.bulan == "10" %}selected{% endif %}>Oktober</option>
<option value="11" {% if request.GET.bulan == "11" %}selected{% endif %}>November</option>
<option value="12" {% if request.GET.bulan == "12" %}selected{% endif %}>Desember</option>
</select>

<select name="tahun" id="filterTahun">
<option value="">Pilih Tahun</option>
{% for t in daftar_tahun %}
<option value="{{ t.year }}" {% if request.GET.tahun == t.year|stringformat:"s" %}selected{% endif %}>{{ t.year }}</option>
{% endfor %}
</select>

<button type="submit">Filter</button>
</form>


<div class="dashboard-layout">

<div class="laporan-section">
<div class="laporan-card">

<h3>Daftar Laporan</h3>

{% for lap in laporan %}
<div class="laporan-item">

<div class="laporan-top d-flex justify-content-between">
<strong>{{ lap.kode_laporan }}</strong>
<span class="status {{ lap.status }}">{{ lap.get_status_display }}</span>
</div>

<p class="laporan-meta">
<strong>Pelapor:</strong>
{{ lap.tampilkan_pelapor }} • {{ lap.get_jenis_bullying_display }} • {{ lap.tanggal|date:"d M Y" }}
</p>

<p class="laporan-meta">
<strong>Korban:</strong>
{{ lap.tampilkan_korban }} ({{ lap.kelas_korban }})
</p>

<a href="{% url 'bk_tindak_lanjut' lap.id %}" class="btn-detail">Lihat Detail</a>

</div>
{% empty %}
<p>Tidak ada laporan</p>
{% endfor %}

</div>
</div>


<div class="chart-section">

<!-- STATUS -->
<div class="chart-card">
<h4>Grafik Status Laporan</h4>
<canvas id="statusChart"></canvas>

<div class="chart-info">
{% for i in grafik_status %}
<span class="info-badge">{{ i.status|title }} : {{ i.total }}</span>
{% endfor %}
<span class="info-total">Total : {{ total_laporan }}</span>
</div>
</div>


<!-- JENIS -->
<div class="chart-card">
<h4>Grafik Jenis Bullying</h4>
<canvas id="jenisChart"></canvas>

<div class="chart-info">
{% for i in grafik_jenis %}
<span class="info-badge">{{ i.jenis_bullying|title }} : {{ i.total }}</span>
{% endfor %}
<span class="info-total">Total : {{ total_laporan }}</span>
</div>
</div>


<!-- KELAS -->
<div class="chart-card">
<h4>Grafik Kelas Korban</h4>
<canvas id="kelasChart"></canvas>

<div class="chart-info">
{% for i in grafik_kelas %}
<span class="info-badge">{{ i.kelas_korban }} : {{ i.total }}</span>
{% endfor %}
<span class="info-total">Total : {{ total_laporan }}</span>
</div>
</div>


<!-- TREN -->
<div class="chart-card">
<h4>Grafik Tren Periode</h4>
<canvas id="trenChart"></canvas>

<div class="chart-info">
{% if tren_detail %}
{% for i in tren_detail %}
<span class="info-badge">{{ i.label }} : {{ i.total }}</span>
{% endfor %}
{% else %}
<span class="info-badge">Tidak ada data tren</span>
{% endif %}
<span class="info-total">Total : {{ total_laporan }}</span>
</div>
</div>

</div>
</div>
</div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

/* GRADIENT KELAS ORANGE → MERAH */
function gradientKelas(data){
const max=Math.max(...data,1);
return data.map(v=>{
let ratio=v/max;
let r=255;
let g=Math.round(165*(1-ratio));
let opacity=0.4+(0.6*ratio);
return `rgba(${r},${g},0,${opacity})`;
});
}


/* GRADIENT TREN KUNING → MERAH */
function gradientTrend(data){
const max=Math.max(...data,1);
return data.map(v=>{
let ratio=v/max;
let r=255;
let g=Math.round(255*(1-ratio));
let opacity=0.4+(0.6*ratio);
return `rgba(${r},${g},0,${opacity})`;
});
}


function chart(id,type,labels,data){

/* HILANGKAN NULL ATAU UNDEFINED */
labels = labels.map(l => l ? l : "Tidak diketahui");
data = data.map(d => d ? d : 0);

let colors=[];

if(id==="statusChart"){
colors=labels.map(l=>{
if(l==="baru") return "#dc3545";
if(l==="diproses") return "#0d6efd";
if(l==="selesai") return "#198754";
return "#6c757d";
});
}

else if(id==="jenisChart"){
colors=labels.map(l=>{
l=l.toLowerCase();
if(l.includes("fisik")) return "#dc3545";
if(l.includes("verbal")) return "#fd7e14";
if(l.includes("sosial")) return "#6f42c1";
if(l.includes("cyber")) return "#0d6efd";
return "#6c757d";
});
}

else if(id==="kelasChart"){
colors=gradientKelas(data);
}

else if(id==="trenChart"){
colors=gradientTrend(data);
}


/* ⭐ KONDISI LEGEND */
let legendOption = {};

if(id !== "statusChart"){
legendOption = {
labels:{
boxWidth:0,
boxHeight:0,
padding:10
}
};
}


new Chart(document.getElementById(id),{
type:type,
data:{
labels:labels,
datasets:[{
label:"Jumlah Laporan",
data:data,
backgroundColor:colors
}]
},
options:{
responsive:true,
maintainAspectRatio:false,

plugins:{
legend:legendOption
},

scales:type!=="pie"?{
y:{
beginAtZero:true,
ticks:{
precision:0,
callback:function(value){
return Number.isInteger(value)?value:null;
}
}
}
}:{}
}
});
}

/* STATUS */
chart("statusChart","pie",
[{% for i in grafik_status %}"{{ i.status|default:'Tidak diketahui' }}",{% endfor %}],
[{% for i in grafik_status %}{{ i.total|default:0 }},{% endfor %}]
);

/* JENIS */
chart("jenisChart","bar",
[{% for i in grafik_jenis %}"{{ i.jenis_bullying|default:'Tidak diketahui' }}",{% endfor %}],
[{% for i in grafik_jenis %}{{ i.total|default:0 }},{% endfor %}]
);

/* KELAS */
chart("kelasChart","bar",
[{% for i in grafik_kelas %}"{{ i.kelas_korban|default:'Tidak diketahui' }}",{% endfor %}],
[{% for i in grafik_kelas %}{{ i.total|default:0 }},{% endfor %}]
);

/* TREN */
chart("trenChart","bar",
[{% for i in grafik_tren %}"{{ i.label|default:'Tidak diketahui' }}",{% endfor %}],
[{% for i in grafik_tren %}{{ i.total|default:0 }},{% endfor %}]
);

</script>


<script>
const periode=document.getElementById("periodeSelect");
const tanggal=document.getElementById("filterTanggal");
const bulan=document.getElementById("filterBulan");
const tahun=document.getElementById("filterTahun");

function updateFilter(){
tanggal.style.display='none';
bulan.style.display='none';
tahun.style.display='none';

if(periode.value==='hari') tanggal.style.display='inline-block';
if(periode.value==='bulan'){
bulan.style.display='inline-block';
tahun.style.display='inline-block';
}
if(periode.value==='tahun') tahun.style.display='inline-block';
}

periode.addEventListener('change',updateFilter);
updateFilter();
</script>


{% endblock %}
