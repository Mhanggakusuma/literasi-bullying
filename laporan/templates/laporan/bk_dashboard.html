{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard Guru BK{% endblock %}

{% block content %}
<div class="bk-dashboard-page">

  <div class="bk-dashboard">

    <!-- ================= HEADER ================= -->
    <header class="dashboard-header">
      <div>
        <span class="bk-badge">Akses Khusus Guru BK</span>
        <h1>Dashboard Guru BK</h1>
        <p>Monitoring dan analisis kasus bullying</p>
      </div>

      <a href="{% url 'bk_download_laporan' %}" class="btn-download">
        <i class="bi bi-download"></i> Download Laporan
      </a>
    </header>

    <!-- ================= SUMMARY ================= -->
    <section class="dashboard-cards">

      <div class="summary-card">
        <p>Total Laporan</p>
        <h2>{{ total_laporan }}</h2>
      </div>

      <div class="summary-card">
        <p>Laporan Baru</p>
        <h2>{{ laporan_baru }}</h2>
      </div>

      <div class="summary-card">
        <p>Diproses</p>
        <h2>{{ sedang_diproses }}</h2>
      </div>

      <div class="summary-card">
        <p>Selesai</p>
        <h2>{{ selesai }}</h2>
      </div>

    </section>

    <!-- ================= FILTER GRAFIK ================= -->
    <form method="get" class="filter-bar">

      <select name="jenis">
        <option value="">Semua Jenis</option>
        {% for val,label in jenis_choices %}
        <option value="{{ val }}">{{ label }}</option>
        {% endfor %}
      </select>

      <select name="kelas">
        <option value="">Semua Kelas</option>
        {% for val,label in kelas_choices %}
        <option value="{{ val }}">{{ label }}</option>
        {% endfor %}
      </select>

      <select name="status">
        <option value="">Semua Status</option>
        <option value="baru">Baru</option>
        <option value="diproses">Diproses</option>
        <option value="selesai">Selesai</option>
      </select>

      <select name="periode">
        <option value="hari">Per Hari</option>
        <option value="bulan" selected>Per Bulan</option>
        <option value="tahun">Per Tahun</option>
      </select>

      <button type="submit" class="btn btn-primary">
        Filter Grafik
      </button>

    </form>

    <!-- ================= GRAFIK ================= -->
    <div class="chart-container">

      <canvas id="statusChart"></canvas>
      <canvas id="jenisChart"></canvas>
      <canvas id="kelasChart"></canvas>
      <canvas id="trenChart"></canvas>

    </div>

    <!-- ================= LIST LAPORAN ================= -->
    <div class="laporan-card mt-5">
      <h3>Daftar Laporan</h3>

      {% for lap in laporan %}
      <div class="laporan-item">

        <div class="laporan-top d-flex justify-content-between">
          <strong>{{ lap.kode_laporan }}</strong>

          <span class="status {{ lap.status }}">
            {{ lap.get_status_display }}
          </span>
        </div>

        <p class="laporan-meta">
          <strong>Pelapor:</strong>
          {{ lap.tampilkan_pelapor(request.user) }}

          • {{ lap.get_jenis_bullying_display }}
          • {{ lap.tanggal|date:"d M Y" }}
        </p>

        <p class="laporan-meta">
          <strong>Korban:</strong>
          {{ lap.tampilkan_korban(request.user) }}
          ({{ lap.kelas_korban }})
        </p>

        <a href="{% url 'bk_tindak_lanjut' lap.id %}" class="btn-detail">
          Lihat Detail
        </a>

      </div>
      {% empty %}
      <p>Tidak ada laporan</p>
      {% endfor %}
    </div>

  </div>
</div>

<!-- ================= CHART JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
new Chart(document.getElementById("statusChart"), {
  type: 'pie',
  data: {
    labels: [{% for i in grafik_status %}"{{ i.status }}",{% endfor %}],
    datasets: [{
      data: [{% for i in grafik_status %}{{ i.total }},{% endfor %}]
    }]
  }
});
</script>

<script>
new Chart(document.getElementById("jenisChart"), {
  type: 'bar',
  data: {
    labels: [{% for i in grafik_jenis %}"{{ i.jenis_bullying }}",{% endfor %}],
    datasets: [{
      data: [{% for i in grafik_jenis %}{{ i.total }},{% endfor %}]
    }]
  }
});
</script>

<script>
new Chart(document.getElementById("kelasChart"), {
  type: 'bar',
  data: {
    labels: [{% for i in grafik_kelas %}"{{ i.kelas_korban }}",{% endfor %}],
    datasets: [{
      data: [{% for i in grafik_kelas %}{{ i.total }},{% endfor %}]
    }]
  }
});
</script>

<script>
new Chart(document.getElementById("trenChart"), {
  type: 'line',
  data: {
    labels: [{% for i in grafik_tren %}"{{ i.waktu|date:'M Y' }}",{% endfor %}],
    datasets: [{
      data: [{% for i in grafik_tren %}{{ i.total }},{% endfor %}]
    }]
  }
});
</script>

{% endblock %}
