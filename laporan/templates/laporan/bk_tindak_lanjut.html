{% extends 'base.html' %}
{% load static %}
{% block title %}Tindak Lanjut Kasus{% endblock %}

{% block content %}
<section class="bk-tindak-lanjut">
  <div class="bk-tl-hero">
    <div class="container text-center">

      <h1 class="bk-tl-title">Tindak Lanjut Kasus Bullying</h1>
      <p class="bk-tl-subtitle">
        Jaga kerahasiaan data demi keamanan dan kenyamanan semua pihak
      </p>

      <div class="bk-tl-card mx-auto mt-5">
        <img src="{% static 'img/ribbon.png' %}" class="bk-tl-icon">

        <div class="bk-tl-info text-start">

          <!-- ================= DATA UMUM ================= -->
          <p><strong>Kode Laporan :</strong> {{ laporan.kode_laporan }}</p>

          <p>
            <strong>Status :</strong>
            <span class="badge
              {% if laporan.status == 'selesai' %}bg-success
              {% elif laporan.status == 'diproses' %}bg-warning
              {% else %}bg-secondary{% endif %}">
              {{ laporan.get_status_display }}
            </span>
          </p>

          <p>
            <strong>Tanggal Lapor :</strong>
            {{ laporan.tanggal|date:"d M Y" }}
          </p>

          <hr>

          <!-- ================= WAKTU & TEMPAT ================= -->
          <p>
            <strong>Waktu Kejadian :</strong>
            {{ laporan.tanggal_kejadian|date:"d M Y" }}
            {% if laporan.perkiraan_waktu %}
              ({{ laporan.get_perkiraan_waktu_display }})
            {% endif %}
          </p>

          <p>
            <strong>Lokasi :</strong>
            {{ laporan.lokasi_kejadian|default:"-" }}
          </p>

          <hr>

          <!-- ================= KORBAN ================= -->
          <p>
            <strong>Korban :</strong>
            {{ laporan.tampilkan_korban(request.user) }}
            ({{ laporan.kelas_korban }})
          </p>

          <!-- ================= TERLAPOR ================= -->
          {% if laporan.nama_terlapor %}
          <p>
            <strong>Terlapor :</strong>
            {{ laporan.nama_terlapor }}
            {% if laporan.kelas_terlapor %}
              ({{ laporan.kelas_terlapor }})
            {% endif %}
          </p>
          {% endif %}

          <p>
            <strong>Jenis :</strong>
            {{ laporan.get_jenis_bullying_display }}
          </p>

          <hr>

          <!-- ================= KRONOLOGI ================= -->
          <p>
            <strong>Kronologi :</strong><br>
            {{ laporan.isi_laporan|linebreaksbr }}
          </p>

          <!-- ================= DAMPAK ================= -->
          {% if laporan.dampak_korban %}
          <hr>
          <p><strong>Dampak :</strong></p>
          <ul>
            {% for d in laporan.dampak_korban %}
              <li>{{ d }}</li>
            {% endfor %}
          </ul>
          {% endif %}

          {% if laporan.dampak_lainnya %}
          <p>
            <strong>Dampak Lainnya :</strong>
            {{ laporan.dampak_lainnya }}
          </p>
          {% endif %}

          <!-- ================= HARAPAN ================= -->
          {% if laporan.harapan_pelapor %}
          <hr>
          <p>
            <strong>Harapan Pelapor :</strong><br>
            {{ laporan.harapan_pelapor|linebreaksbr }}
          </p>
          {% endif %}

          <!-- ================= BUKTI ================= -->
          {% if laporan.bukti %}
          <a href="{{ laporan.bukti.url }}"
             target="_blank"
             class="bk-tl-btn-success w-100 my-3">
            üìé Lihat Bukti Pelapor
          </a>
          {% endif %}

          <!-- ================= IDENTITAS INTERNAL BK ================= -->
          <hr>
          <details class="mt-4">
            <summary style="cursor:pointer; font-weight:700;">
              üîê Identitas Pelapor (Internal BK)
            </summary>

            <div class="mt-3">

              <p>
                <strong>Nama :</strong>
                {{ laporan.pelapor.get_full_name|default:laporan.pelapor.username }}
              </p>

              <p>
                <strong>NIS :</strong>
                {{ laporan.pelapor.profile.nis }}
              </p>

              <p>
                <strong>Kelas :</strong>
                {{ laporan.pelapor.profile.kelas }}
              </p>

              <small class="text-muted">
                Data ini hanya untuk keperluan penanganan kasus.
              </small>

            </div>
          </details>

          <!-- ================= FORM BK ================= -->
          <hr>
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <label class="bk-tl-label">Catatan Guru BK</label>
            {{ form.catatan_bk }}

            <label class="bk-tl-label mt-3">
              Bukti Tindak Lanjut
            </label>
            {{ form.bukti_tindak_lanjut }}

            <button type="submit"
                    class="bk-tl-btn-primary w-100 mt-4">
              Simpan Tindak Lanjut
            </button>

            {% if laporan.status != "selesai" %}
            <button type="submit"
                    name="selesai"
                    value="1"
                    class="btn btn-success w-100 mt-2">
              Tandai Selesai
            </button>
            {% endif %}

          </form>

          <a href="{% url 'bk_dashboard' %}"
             class="btn btn-outline-secondary w-100 mt-3">
            ‚Üê Kembali
          </a>

        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}
