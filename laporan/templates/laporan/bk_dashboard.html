{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard Guru BK{% endblock %}

{% block content %}
<div class="bk-dashboard-page">
  <div class="bk-dashboard">

    <!-- HEADER -->
    <header class="dashboard-header">
      <div>
        <span class="bk-badge">Akses Khusus Guru BK</span>
        <h1>Dashboard Guru BK</h1>
        <p>Monitoring dan analisis kasus bullying</p>
      </div>

      <a href="{% url 'bk_download_laporan' %}" class="btn-download">
        Download Laporan
      </a>
    </header>

    <!-- SUMMARY -->
    <section class="dashboard-cards">
      <div class="summary-card">
        <p>Total Laporan</p>
        <h2>{{ total_laporan }}</h2>
      </div>

      <div class="summary-card">
        <p>Laporan Baru</p>
        <h2>{{ laporan_baru }}</h2>
      </div>

      <div class="summary-card">
        <p>Diproses</p>
        <h2>{{ sedang_diproses }}</h2>
      </div>

      <div class="summary-card">
        <p>Selesai</p>
        <h2>{{ selesai }}</h2>
      </div>
    </section>

    <!-- FILTER SIMPLE -->
    <form method="get" class="filter-bar">

      <select name="jenis">
        <option value="">Semua Jenis</option>
        {% for val,label in jenis_choices %}
        <option value="{{ val }}" {% if val == selected_jenis %}selected{% endif %}>
          {{ label }}
        </option>
        {% endfor %}
      </select>

      <select name="kelas">
        <option value="">Semua Kelas</option>
        {% for val,label in kelas_choices %}
        <option value="{{ val }}" {% if val == selected_kelas %}selected{% endif %}>
          {{ label }}
        </option>
        {% endfor %}
      </select>

      <select name="status">
        <option value="">Semua Status</option>
        <option value="baru" {% if selected_status == "baru" %}selected{% endif %}>Baru</option>
        <option value="diproses" {% if selected_status == "diproses" %}selected{% endif %}>Diproses</option>
        <option value="selesai" {% if selected_status == "selesai" %}selected{% endif %}>Selesai</option>
      </select>

      <select name="periode" id="periodeSelect">
        <option value="semua" {% if periode == "semua" %}selected{% endif %}>Semua Waktu</option>
        <option value="hari" {% if periode == "hari" %}selected{% endif %}>Per Hari</option>
        <option value="bulan" {% if periode == "bulan" %}selected{% endif %}>Per Bulan</option>
        <option value="tahun" {% if periode == "tahun" %}selected{% endif %}>Per Tahun</option>
      </select>

      <input type="date" name="tanggal" id="filterTanggal" value="{{ request.GET.tanggal }}">

      <select name="bulan" id="filterBulan">
        <option value="">Bulan</option>
        {% for m in "123456789101112"|make_list %}
        <option value="{{ forloop.counter }}" {% if request.GET.bulan == forloop.counter|stringformat:"s" %}selected{% endif %}>
          {{ forloop.counter }}
        </option>
        {% endfor %}
      </select>

      <select name="tahun" id="filterTahun">
        <option value="">Tahun</option>
        {% for t in daftar_tahun %}
        <option value="{{ t.year }}" {% if request.GET.tahun == t.year|stringformat:"s" %}selected{% endif %}>
          {{ t.year }}
        </option>
        {% endfor %}
      </select>

      <button type="submit" class="btn btn-primary">Filter</button>
    </form>

    <!-- MAIN DASHBOARD -->
    <div class="dashboard-main">

      <!-- LAPORAN -->
      <div class="laporan-area">
        <h3>Daftar Laporan</h3>

        {% for lap in laporan %}
        <div class="laporan-item">

          <div class="laporan-top d-flex justify-content-between">
            <strong>{{ lap.kode_laporan }}</strong>

            <span class="status {{ lap.status }}">
              {{ lap.get_status_display }}
            </span>
          </div>

          <p class="laporan-meta">
            <strong>Pelapor:</strong>
            {{ lap.tampilkan_pelapor }}
            • {{ lap.get_jenis_bullying_display }}
            • {{ lap.tanggal|date:"d M Y" }}
          </p>

          <p class="laporan-meta">
            <strong>Korban:</strong>
            {{ lap.tampilkan_korban }}
            ({{ lap.kelas_korban }})
          </p>

          <a href="{% url 'bk_tindak_lanjut' lap.id %}" class="btn-detail">
            Lihat Detail
          </a>

        </div>
        {% empty %}
        <p>Tidak ada laporan</p>
        {% endfor %}
      </div>


      <!-- CHART -->
      <div class="chart-area">

        <div class="chart-card">
          <canvas id="statusChart"></canvas>
        </div>

        <div class="chart-card">
          <canvas id="jenisChart"></canvas>
        </div>

        <div class="chart-card">
          <canvas id="kelasChart"></canvas>
        </div>

        <div class="chart-card">
          <canvas id="trenChart"></canvas>
        </div>

      </div>

    </div>

  </div>
</div>

<style>

/* GRID */
.dashboard-main {
  display: grid;
  grid-template-columns: 1.2fr 1.8fr;
  gap: 30px;
  margin-top: 25px;
}

/* FILTER SIMPLE */
.filter-bar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.filter-bar select,
.filter-bar input {
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ced4da;
  min-width: 140px;
}

/* CHART */
.chart-area {
  display: grid;
  grid-template-columns: repeat(2,1fr);
  gap: 20px;
}

.chart-card {
  background: #ffffff;
  padding: 18px;
  border-radius: 16px;
  box-shadow: 0 8px 25px rgba(0,0,0,.12);
}

.chart-card canvas {
  height: 260px !important;
}

/* RESPONSIVE */
@media (max-width:992px){
  .dashboard-main {
    grid-template-columns: 1fr;
  }

  .chart-area {
    grid-template-columns: 1fr;
  }
}

</style>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- STATUS CHART FIX -->
<script>
new Chart(document.getElementById("statusChart"), {
  type: 'pie',
  data: {
    labels: [
      {% for i in grafik_status %}
        "{% if i.status == 'baru' %}Laporan Baru{% elif i.status == 'diproses' %}Sedang Diproses{% else %}Selesai Ditangani{% endif %}",
      {% endfor %}
    ],
    datasets: [{
      data: [{% for i in grafik_status %}{{ i.total }},{% endfor %}],
      backgroundColor: ["#6c757d","#ff9800","#198754"]
    }]
  }
});
</script>

<script>
new Chart(document.getElementById("jenisChart"), {
  type:'bar',
  data:{
    labels:[{% for i in grafik_jenis %}"{{ i.jenis_bullying|title }}",{% endfor %}],
    datasets:[{ data:[{% for i in grafik_jenis %}{{ i.total }},{% endfor %}] }]
  }
});
</script>

<script>
new Chart(document.getElementById("kelasChart"), {
  type:'bar',
  data:{
    labels:[{% for i in grafik_kelas %}"{{ i.kelas_korban }}",{% endfor %}],
    datasets:[{ data:[{% for i in grafik_kelas %}{{ i.total }},{% endfor %}] }]
  }
});
</script>

<script>
new Chart(document.getElementById("trenChart"), {
  type:'line',
  data:{
    labels:[{% for i in grafik_tren %}"{{ i.waktu|date:'d M Y' }}",{% endfor %}],
    datasets:[{ data:[{% for i in grafik_tren %}{{ i.total }},{% endfor %}] }]
  }
});
</script>

<script>
const periode = document.getElementById("periodeSelect");
const tanggal = document.getElementById("filterTanggal");
const bulan = document.getElementById("filterBulan");
const tahun = document.getElementById("filterTahun");

function updateFilter(){
  tanggal.style.display="none";
  bulan.style.display="none";
  tahun.style.display="none";

  if(periode.value==="hari"){ tanggal.style.display="inline-block"; }
  if(periode.value==="bulan"){ bulan.style.display="inline-block"; tahun.style.display="inline-block"; }
  if(periode.value==="tahun"){ tahun.style.display="inline-block"; }
}

periode.addEventListener("change", updateFilter);
updateFilter();
</script>

{% endblock %}
