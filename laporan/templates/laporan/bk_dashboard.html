{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard Guru BK{% endblock %}

{% block content %}
<div class="bk-dashboard-page">
  <div class="bk-dashboard">

    <!-- HEADER -->
    <header class="dashboard-header">
      <div>
        <span class="bk-badge">Akses Khusus Guru BK</span>
        <h1>Dashboard Guru BK</h1>
        <p>Monitoring dan analisis tren kasus bullying</p>
      </div>
      <a href="{% url 'bk_download_laporan' %}" class="btn-download">Download Laporan</a>
    </header>

    <!-- SUMMARY -->
    <section class="dashboard-cards">
      <div class="summary-card">
        <p>Total Laporan</p>
        <h2>{{ total_laporan }}</h2>
      </div>
      <div class="summary-card">
        <p>Laporan Baru</p>
        <h2>{{ laporan_baru }}</h2>
      </div>
      <div class="summary-card">
        <p>Diproses</p>
        <h2>{{ sedang_diproses }}</h2>
      </div>
      <div class="summary-card">
        <p>Selesai</p>
        <h2>{{ selesai }}</h2>
      </div>
    </section>

    <!-- FILTER -->
    <form method="get" class="filter-bar">
      <select name="jenis">
        <option value="">Semua Jenis</option>
        {% for val,label in jenis_choices %}
        <option value="{{ val }}" {% if val == selected_jenis %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      <select name="kelas">
        <option value="">Semua Kelas</option>
        {% for val,label in kelas_choices %}
        <option value="{{ val }}" {% if val == selected_kelas %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      <select name="status">
        <option value="">Semua Status</option>
        <option value="baru" {% if selected_status == "baru" %}selected{% endif %}>Baru</option>
        <option value="diproses" {% if selected_status == "diproses" %}selected{% endif %}>Diproses</option>
        <option value="selesai" {% if selected_status == "selesai" %}selected{% endif %}>Selesai</option>
      </select>

      <select name="periode" id="periodeSelect">
        <option value="semua" {% if periode == "semua" %}selected{% endif %}>Semua Waktu</option>
        <option value="hari" {% if periode == "hari" %}selected{% endif %}>Per Hari</option>
        <option value="bulan" {% if periode == "bulan" %}selected{% endif %}>Per Bulan</option>
        <option value="tahun" {% if periode == "tahun" %}selected{% endif %}>Per Tahun</option>
      </select>

      <input type="date" name="tanggal" id="filterTanggal">

      <select name="bulan" id="filterBulan">
        <option value="">Pilih Bulan</option>
        <option value="1" {% if request.GET.bulan == "1" %}selected{% endif %}>Januari</option>
        <option value="2" {% if request.GET.bulan == "2" %}selected{% endif %}>Februari</option>
        <option value="3" {% if request.GET.bulan == "3" %}selected{% endif %}>Maret</option>
        <option value="4" {% if request.GET.bulan == "4" %}selected{% endif %}>April</option>
        <option value="5" {% if request.GET.bulan == "5" %}selected{% endif %}>Mei</option>
        <option value="6" {% if request.GET.bulan == "6" %}selected{% endif %}>Juni</option>
        <option value="7" {% if request.GET.bulan == "7" %}selected{% endif %}>Juli</option>
        <option value="8" {% if request.GET.bulan == "8" %}selected{% endif %}>Agustus</option>
        <option value="9" {% if request.GET.bulan == "9" %}selected{% endif %}>September</option>
        <option value="10" {% if request.GET.bulan == "10" %}selected{% endif %}>Oktober</option>
        <option value="11" {% if request.GET.bulan == "11" %}selected{% endif %}>November</option>
        <option value="12" {% if request.GET.bulan == "12" %}selected{% endif %}>Desember</option>
      </select>

      <select name="tahun" id="filterTahun">
        <option value="">Pilih Tahun</option>
        {% for t in daftar_tahun %}
        <option value="{{ t.year }}">{{ t.year }}</option>
        {% endfor %}
      </select>

      <button type="submit" class="btn btn-primary">Filter</button>
    </form>

    <!-- CHARTS -->
    <div class="chart-container">
      <div class="chart-card">
        <h4>Grafik Status Laporan</h4>
        <canvas id="statusChart"></canvas>
      </div>

      <div class="chart-card">
        <h4>Grafik Jenis Bullying</h4>
        <canvas id="jenisChart"></canvas>
      </div>

      <div class="chart-card">
        <h4>Grafik Kelas Korban</h4>
        <canvas id="kelasChart"></canvas>
      </div>

      <div class="chart-card">
        <h4>Grafik Tren Periode (Naik / Turun)</h4>
        <canvas id="trenChart"></canvas>
      </div>
    </div>

    <!-- LIST LAPORAN -->
    <div class="laporan-card mt-5">
      <h3>Daftar Laporan</h3>
      {% for lap in laporan %}
      <div class="laporan-item">
        <div class="laporan-top d-flex justify-content-between">
          <strong>{{ lap.kode_laporan }}</strong>
          <span class="status {{ lap.status }}">{{ lap.get_status_display }}</span>
        </div>

        <p class="laporan-meta">
          <strong>Pelapor:</strong> {{ lap.tampilkan_pelapor }} • {{ lap.get_jenis_bullying_display }} • {{ lap.tanggal|date:"d M Y" }}
        </p>

        <p class="laporan-meta">
          <strong>Korban:</strong> {{ lap.tampilkan_korban }} ({{ lap.kelas_korban }})
        </p>

        <a href="{% url 'bk_tindak_lanjut' lap.id %}" class="btn-detail">Lihat Detail</a>
      </div>
      {% empty %}
      <p>Tidak ada laporan</p>
      {% endfor %}
    </div>

  </div>
</div>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ---------- COMMON OPTIONS ---------- */
const sharedOptions = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: { position: 'top' },
    tooltip: {
      mode: 'index',
      intersect: false
    }
  },
  scales: {
    x: {
      grid: {
        color: '#e9ecef',
        borderDash: [2,2]
      }
    },
    y: {
      beginAtZero: true,
      grid: {
        color: '#e9ecef',
        borderDash: [2,2]
      },
      ticks: {
        precision: 0,
        stepSize: 1
      }
    }
  }
};

/* ---------- STATUS (PIE) ---------- */
new Chart(document.getElementById("statusChart"), {
  type: 'pie',
  data: {
    labels: [{% for i in grafik_status %}"{{ i.status }}",{% endfor %}],
    datasets: [{
      data: [{% for i in grafik_status %}{{ i.total }},{% endfor %}],
      backgroundColor: [
        'rgba(108,117,125,0.9)',
        'rgba(255,159,64,0.9)',
        'rgba(25,135,84,0.9)'
      ],
      borderWidth: 1
    }]
  },
  options: { responsive:true, plugins:{legend:{position:'top'}} }
});

/* ---------- JENIS (BAR) ---------- */
new Chart(document.getElementById("jenisChart"), {
  type: 'bar',
  data: {
    labels: [{% for i in grafik_jenis %}"{{ i.jenis_bullying }}",{% endfor %}],
    datasets: [{
      label: "Jumlah Kasus",
      data: [{% for i in grafik_jenis %}{{ i.total }},{% endfor %}],
      backgroundColor: 'rgba(13,110,253,0.9)',
      borderRadius: 6,
      barPercentage: 0.6
    }]
  },
  options: JSON.parse(JSON.stringify(sharedOptions))
});

/* ---------- KELAS (BAR) ---------- */
new Chart(document.getElementById("kelasChart"), {
  type: 'bar',
  data: {
    labels: [{% for i in grafik_kelas %}"{{ i.kelas_korban }}",{% endfor %}],
    datasets: [{
      label: "Jumlah Kasus",
      data: [{% for i in grafik_kelas %}{{ i.total }},{% endfor %}],
      backgroundColor: 'rgba(75,192,192,0.7)',
      borderRadius: 6,
      barPercentage: 0.6
    }]
  },
  options: JSON.parse(JSON.stringify(sharedOptions))
});


/* ---------- TREN (LINE) - NAIK TURUN ---------- */
/* key: line tegas (tension:0), titik besar (pointRadius), garis tebal (borderWidth), grid jelas */
const trenCtx = document.getElementById("trenChart");
trenCtx.height = 320; // pastikan tinggi supaya tampil rapi

new Chart(trenCtx, {
  type: 'line',
  data: {
    labels: [{% for i in grafik_tren %}"{{ i.waktu|date:'M Y' }}",{% endfor %}],
    datasets: [{
      label: "Tren Laporan",
      data: [{% for i in grafik_tren %}{{ i.total }},{% endfor %}],
      borderColor: '#0d6efd',
      backgroundColor: 'rgba(13,110,253,0.08)',
      borderWidth: 3,
      pointRadius: 6,
      pointHoverRadius: 8,
      pointBackgroundColor: '#0d6efd',
      tension: 0, // GARIS LURUS agar mirip contoh (tidak melengkung)
      fill: false
    }]
  },
  options: JSON.parse(JSON.stringify(sharedOptions))
});
</script>

<!-- FILTER DYNAMIC -->
<script>
const periode = document.getElementById("periodeSelect");
const tanggal = document.getElementById("filterTanggal");
const bulan = document.getElementById("filterBulan");
const tahun = document.getElementById("filterTahun");

function updateFilter(){
  tanggal.style.display = 'none';
  bulan.style.display = 'none';
  tahun.style.display = 'none';

  if (periode.value === 'hari') { tanggal.style.display = 'inline-block'; }
  if (periode.value === 'bulan') { bulan.style.display = 'inline-block'; tahun.style.display = 'inline-block'; }
  if (periode.value === 'tahun') { tahun.style.display = 'inline-block'; }
}

periode.addEventListener('change', updateFilter);
updateFilter();
</script>

{% endblock %}
